# PIPELINE DEFINITION
# Name: vellum-ingestion-pipeline
# Description: Ingests documents from MinIO to ChromaDB using LlamaIndex
# Inputs:
#    bucket: str [Default: 'documents']
#    chroma_host: str [Default: 'chroma-service.kubeflow.svc.cluster.local']
#    minio_endpoint: str [Default: 'minio-service.kubeflow.svc:9000']
#    prefix: str [Default: '']
components:
  comp-ingest-documents-op:
    executorLabel: exec-ingest-documents-op
    inputDefinitions:
      parameters:
        bucket:
          parameterType: STRING
        chroma_host:
          defaultValue: chroma-service.kubeflow.svc.cluster.local
          isOptional: true
          parameterType: STRING
        chroma_port:
          defaultValue: 8000.0
          isOptional: true
          parameterType: NUMBER_INTEGER
        minio_access_key:
          defaultValue: minio
          isOptional: true
          parameterType: STRING
        minio_endpoint:
          defaultValue: minio-service.kubeflow.svc:9000
          isOptional: true
          parameterType: STRING
        minio_secret_key:
          defaultValue: minio123
          isOptional: true
          parameterType: STRING
        prefix:
          defaultValue: ''
          isOptional: true
          parameterType: STRING
deploymentSpec:
  executors:
    exec-ingest-documents-op:
      container:
        args:
        - --executor_input
        - '{{$}}'
        - --function_to_execute
        - ingest_documents_op
        command:
        - sh
        - -c
        - "\nif ! [ -x \"$(command -v pip)\" ]; then\n    python3 -m ensurepip ||\
          \ python3 -m ensurepip --user || apt-get install python3-pip\nfi\n\nPIP_DISABLE_PIP_VERSION_CHECK=1\
          \ python3 -m pip install --quiet --no-warn-script-location 'kfp==2.2.0'\
          \ '--no-deps' 'typing-extensions>=3.7.4,<5; python_version<\"3.9\"' && \"\
          $0\" \"$@\"\n"
        - sh
        - -ec
        - 'program_path=$(mktemp -d)


          printf "%s" "$0" > "$program_path/ephemeral_component.py"

          _KFP_RUNTIME=true python3 -m kfp.dsl.executor_main                         --component_module_path                         "$program_path/ephemeral_component.py"                         "$@"

          '
        - "\nimport kfp\nfrom kfp import dsl\nfrom kfp.dsl import *\nfrom typing import\
          \ *\n\ndef ingest_documents_op(\n    bucket: str,\n    prefix: str = \"\"\
          ,\n    minio_endpoint: str = \"minio-service.kubeflow.svc:9000\",\n    minio_access_key:\
          \ str = \"minio\",\n    minio_secret_key: str = \"minio123\",\n    chroma_host:\
          \ str = \"chroma-service.kubeflow.svc.cluster.local\",\n    chroma_port:\
          \ int = 8000\n):\n    import subprocess\n    import sys\n\n    print(f\"\
          Launching ingestion from MinIO {bucket}/{prefix}\")\n\n    # Call the script\
          \ that resides at /app/run_ingestion.py (from Dockerfile)\n    cmd = [\n\
          \        \"python\", \n        \"/app/run_ingestion.py\",\n        \"--bucket\"\
          , bucket,\n        \"--prefix\", prefix,\n        \"--minio_endpoint\",\
          \ minio_endpoint,\n        \"--minio_access_key\", minio_access_key,\n \
          \       \"--minio_secret_key\", minio_secret_key,\n        \"--chroma_host\"\
          , chroma_host,\n        \"--chroma_port\", str(chroma_port)\n    ]\n\n \
          \   result = subprocess.run(cmd, capture_output=True, text=True)\n\n   \
          \ print(result.stdout)\n    if result.stderr:\n        print(\"STDERR:\"\
          , result.stderr, file=sys.stderr)\n\n    if result.returncode != 0:\n  \
          \      raise RuntimeError(f\"Ingestion failed with code {result.returncode}\"\
          )\n\n"
        image: vellum-ingest:local
pipelineInfo:
  description: Ingests documents from MinIO to ChromaDB using LlamaIndex
  name: vellum-ingestion-pipeline
root:
  dag:
    tasks:
      ingest-documents-op:
        cachingOptions:
          enableCache: true
        componentRef:
          name: comp-ingest-documents-op
        inputs:
          parameters:
            bucket:
              componentInputParameter: bucket
            chroma_host:
              componentInputParameter: chroma_host
            minio_endpoint:
              componentInputParameter: minio_endpoint
            prefix:
              componentInputParameter: prefix
        taskInfo:
          name: ingest-documents-op
  inputDefinitions:
    parameters:
      bucket:
        defaultValue: documents
        isOptional: true
        parameterType: STRING
      chroma_host:
        defaultValue: chroma-service.kubeflow.svc.cluster.local
        isOptional: true
        parameterType: STRING
      minio_endpoint:
        defaultValue: minio-service.kubeflow.svc:9000
        isOptional: true
        parameterType: STRING
      prefix:
        defaultValue: ''
        isOptional: true
        parameterType: STRING
schemaVersion: 2.1.0
sdkVersion: kfp-2.2.0
