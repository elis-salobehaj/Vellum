apiVersion: kubeflow.org/v1beta1
kind: Experiment
metadata:
  name: rag-tuning-v4
  namespace: kubeflow-user-example-com
spec:
  parallelTrialCount: 6
  maxTrialCount: 12
  maxFailedTrialCount: 3
  objective:
    type: maximize
    goal: 0.85
    objectiveMetricName: accuracy
    additionalMetricNames: []
  algorithm:
    algorithmName: grid
  metricsCollectorSpec:
    collector:
      kind: StdOut
  parameters:
    - name: chunk_size
      parameterType: categorical
      feasibleSpace:
        list: ["128", "256", "512", "1024"]
    - name: chunk_overlap
      parameterType: categorical
      feasibleSpace:
        list: ["20", "50", "100"]
  trialTemplate:
    primaryContainerName: main
    retain: true
    successCondition: status.conditions.#(type=="Complete")#|#(status=="True")#
    failureCondition: status.conditions.#(type=="Failed")#|#(status=="True")#
    trialParameters:
      - name: chunkSize
        description: Chunk size for modification
        reference: chunk_size
      - name: chunkOverlap
        description: Chunk overlap for modification
        reference: chunk_overlap
    trialSpec:
      apiVersion: batch/v1
      kind: Job
      spec:
        template:
          metadata:
            annotations:
              sidecar.istio.io/inject: "false"
          spec:
            restartPolicy: Never
            containers:
              - name: main
                image: vellum-ingest:local
                command:
                  - "python"
                  - "/app/run_ingestion.py"
                  - "--bucket"
                  - "documents"
                  - "--minio_endpoint"
                  - "minio-service.kubeflow.svc:9000"
                  - "--qdrant_host"
                  - "qdrant.qdrant.svc.cluster.local"
                  - "--chunk_size"
                  - "${trialParameters.chunkSize}"
                  - "--chunk_overlap"
                  - "${trialParameters.chunkOverlap}"
                  - "--max_docs"
                  - "2"
                  - "--model_name"
                  - "BAAI/bge-small-en-v1.5"
                imagePullPolicy: Never
